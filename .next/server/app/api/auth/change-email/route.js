(()=>{var e={};e.id=750,e.ids=[750],e.modules={7581:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=7581,e.exports=t},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{"use strict";e.exports=require("crypto")},7147:e=>{"use strict";e.exports=require("fs")},6005:e=>{"use strict";e.exports=require("node:crypto")},1017:e=>{"use strict";e.exports=require("path")},3837:e=>{"use strict";e.exports=require("util")},3106:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>w,serverHooks:()=>y,staticGenerationAsyncStorage:()=>x});var a={};r.r(a),r.d(a,{POST:()=>h});var s=r(9303),n=r(8716),i=r(670),o=r(6005),u=r(7070),c=r(6263),l=r(9178),p=r(3493),d=r(1528);let m=c.Ryn({newEmail:c.Z_8().email(),currentPassword:c.Z_8().min(1)});async function h(e){let t=await (0,l.ts)();if(!t)return u.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json().catch(()=>null),a=m.safeParse(r);if(!a.success)return u.NextResponse.json({error:"Invalid input"},{status:400});let s=(0,l.R)(a.data.newEmail);if(s===t.email)return u.NextResponse.json({error:"Email is unchanged"},{status:400});if(!await (0,l.Gv)(a.data.currentPassword,t.passwordHash))return u.NextResponse.json({error:"Incorrect password"},{status:403});if(await p.prisma.user.findUnique({where:{email:s}}))return u.NextResponse.json({error:"Email is already in use"},{status:409});await p.prisma.user.update({where:{id:t.id},data:{pendingEmail:s}}),await p.prisma.verificationToken.deleteMany({where:{userId:t.id,type:"EMAIL"}});let n=(0,o.randomBytes)(48).toString("hex"),i=(0,l.fm)(`${n}:${s}`);return await p.prisma.verificationToken.create({data:{userId:t.id,tokenHash:i,type:"EMAIL",expiresAt:new Date(Date.now()+864e5)}}),await (0,d.z)(s,n,s),u.NextResponse.json({message:"Check your inbox to verify the new email. Your current email stays active until you confirm.",user:{id:t.id,email:t.email}})}let w=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/auth/change-email/route",pathname:"/api/auth/change-email",filename:"route",bundlePath:"app/api/auth/change-email/route"},resolvedPagePath:"C:\\Users\\kirk\\Downloads\\Coding Projects\\gmrecall\\app\\api\\auth\\change-email\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:x,serverHooks:y}=w,g="/api/auth/change-email/route";function v(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:x})}},9178:(e,t,r)=>{"use strict";r.d(t,{Gv:()=>p,R:()=>u,Rf:()=>f,Xz:()=>c,c_:()=>l,claimAvailableUsername:()=>m,ed:()=>w,fm:()=>d,i8:()=>g,ts:()=>x,wb:()=>y});var a=r(8691),s=r(1615),n=r(6005),i=r(3493);let o="gm_session";function u(e){return e.trim().toLowerCase()}function c(e){return e.trim().toLowerCase()}async function l(e){return a.ZP.hash(e,12)}async function p(e,t){return a.ZP.compare(e,t)}function d(e){return(0,n.createHash)("sha256").update(e).digest("hex")}async function m(e){let t=e?.trim();if(t){let e=c(t);if(!await i.prisma.user.findUnique({where:{usernameLower:e}}))return{username:t,usernameLower:e}}let r=0;for(;r<8;){let e=`user-${Math.floor(9e5*Math.random()+1e5)}`,t=c(e);if(!await i.prisma.user.findUnique({where:{usernameLower:t}}))return{username:e,usernameLower:t};r++}throw Error("Unable to assign username")}function h(){return(0,s.cookies)()}async function w(e,t=!1){let r=(0,n.randomBytes)(48).toString("hex"),a=d(r),s=new Date(Date.now()+(t?2592e6:6048e5));await i.prisma.session.create({data:{userId:e,tokenHash:a,expiresAt:s}}),h().set(o,r,{httpOnly:!0,sameSite:"lax",secure:!0,expires:s,path:"/"})}async function f(){let e=h(),t=e.get(o)?.value;if(t){let e=d(t);await i.prisma.session.deleteMany({where:{tokenHash:e}})}e.set(o,"",{httpOnly:!0,sameSite:"lax",secure:!0,expires:new Date(0),path:"/"})}async function x(){let e=h(),t=e.get(o)?.value;if(!t)return null;let r=d(t),a=await i.prisma.session.findFirst({where:{tokenHash:r,expiresAt:{gt:new Date}},include:{user:!0}});return a?a.user:(e.delete(o),null)}async function y(e){let t=(0,n.randomBytes)(48).toString("hex"),r=d(t),a=new Date(Date.now()+864e5);return{token:t,record:await i.prisma.verificationToken.create({data:{userId:e,tokenHash:r,expiresAt:a,type:"EMAIL"}})}}async function g(e){await i.prisma.verificationToken.deleteMany({where:{userId:e,type:"EMAIL"}})}},1528:(e,t,r)=>{"use strict";r.d(t,{z:()=>n});let{APP_BASE_URL:a,NEXT_PUBLIC_BASE_URL:s}=process.env;async function n(e,t,r){let n=new URL("/api/auth/verify-email",a??s??"http://localhost:3000");n.searchParams.set("token",t),r&&n.searchParams.set("newEmail",r),console.warn("Verification email stubbed. Send this link manually:",{to:e,verifyUrl:n.toString(),newEmail:r??null})}},3493:(e,t,r)=>{"use strict";r.d(t,{prisma:()=>u});var a=r(8879);let s=require("@prisma/client"),n=global,i=(process.env.DATABASE_URL??"file:./dev.db").replace(/^file:/,""),o=n.adapter??new a.d({url:i}),u=n.prisma||new s.PrismaClient({adapter:o,log:["error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,979,263],()=>r(3106));module.exports=a})();